<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>CRUD Produtos - Firebase Realtime DB + Storage</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { color: #333; }
    input, button { margin: 5px; padding: 8px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    .actions button { margin: 0 4px; }
    img { max-height: 60px; border-radius: 4px; }
    .uploading { color: #0a7a5b; font-size: 12px; }
  </style>
</head>
<body>
  <h1>Cadastro de Produtos</h1>

  <div>
    <input type="hidden" id="produtoId">
    <input type="text" id="descricao" placeholder="Descrição do Produto">
    <input type="number" id="valor" placeholder="Valor (R$)" step="0.01">
    <input type="number" id="quantidade" placeholder="Quantidade">
    <input type="number" id="estoque" placeholder="Estoque (unidades)">
    <input type="file" id="imagemFile" accept="image/*">
    <span id="statusUpload"></span><br>
    <button id="btnSalvar">Salvar</button>
    <button id="btnLimpar">Limpar</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Imagem</th>
        <th>Descrição</th>
        <th>Valor (R$)</th>
        <th>Quantidade</th>
        <th>Estoque</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="listaProdutos"></tbody>
  </table>

  <script>
    // --- Substitua pelos dados do seu projeto ---
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAkWWKZy_Fsz7R8tdkfSvdkkHOQPbuluf8",
  authDomain: "cadastro-loja-7ca10.firebaseapp.com",
  databaseURL: "https://cadastro-loja-7ca10-default-rtdb.firebaseio.com",
  projectId: "cadastro-loja-7ca10",
  storageBucket: "cadastro-loja-7ca10.firebasestorage.app",
  messagingSenderId: "163391237141",
  appId: "1:163391237141:web:a1c3f4273d282196dc721c",
  measurementId: "G-2T145M35SC"
};

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const produtosRef = db.ref("produtos");
    const storage = firebase.storage();

    const inputId = document.getElementById('produtoId');
    const inputDescricao = document.getElementById('descricao');
    const inputValor = document.getElementById('valor');
    const inputQuantidade = document.getElementById('quantidade');
    const inputEstoque = document.getElementById('estoque');
    const inputImagemFile = document.getElementById('imagemFile');
    const statusUpload = document.getElementById('statusUpload');
    const btnSalvar = document.getElementById('btnSalvar');
    const btnLimpar = document.getElementById('btnLimpar');
    const tbody = document.getElementById('listaProdutos');

    let imagemURLTemp = ""; // armazena a URL depois do upload

    function validarCampos() {
      if (!inputDescricao.value.trim()) { alert('Descrição é obrigatória'); return false; }
      if (inputValor.value === "" || isNaN(parseFloat(inputValor.value))) { alert('Valor inválido'); return false; }
      if (inputQuantidade.value === "" || isNaN(parseInt(inputQuantidade.value))) { alert('Quantidade inválida'); return false; }
      if (inputEstoque.value === "" || isNaN(parseInt(inputEstoque.value))) { alert('Estoque inválido'); return false; }
      return true;
    }

    async function salvarProduto() {
      if (!validarCampos()) return;

      const id = inputId.value || null;
      const produto = {
        descricao: inputDescricao.value.trim(),
        valor: parseFloat(Number(inputValor.value).toFixed(2)),
        quantidade: parseInt(inputQuantidade.value, 10),
        estoque: parseInt(inputEstoque.value, 10),
        imagemURL: imagemURLTemp || "",
        updatedAt: Date.now()
      };

      if (id) {
        await produtosRef.child(id).update(produto);
      } else {
        const newRef = produtosRef.push();
        produto.createdAt = Date.now();
        await newRef.set(produto);
      }
      limparCampos();
    }

    function limparCampos() {
      inputId.value = "";
      inputDescricao.value = "";
      inputValor.value = "";
      inputQuantidade.value = "";
      inputEstoque.value = "";
      inputImagemFile.value = "";
      imagemURLTemp = "";
      statusUpload.textContent = "";
      btnSalvar.textContent = "Salvar";
    }

    function montarLinha(id, produto) {
      const tr = document.createElement("tr");

      const tdImg = document.createElement("td");
      const img = document.createElement("img");
      img.src = produto.imagemURL || "https://via.placeholder.com/60x60?text=Sem+Imagem";
      tdImg.appendChild(img);

      const tdDesc = document.createElement("td"); tdDesc.textContent = produto.descricao;
      const tdValor = document.createElement("td"); tdValor.textContent = (produto.valor || 0).toFixed(2);
      const tdQtd = document.createElement("td"); tdQtd.textContent = produto.quantidade ?? "";
      const tdEst = document.createElement("td"); tdEst.textContent = produto.estoque ?? 0;

      const tdAcoes = document.createElement("td");
      const btnEditar = document.createElement("button"); btnEditar.textContent = "Editar";
      btnEditar.onclick = () => iniciarEdicao(id, produto);
      const btnExcluir = document.createElement("button"); btnExcluir.textContent = "Excluir";
      btnExcluir.onclick = () => { if (confirm("Excluir produto?")) produtosRef.child(id).remove(); };
      tdAcoes.appendChild(btnEditar); tdAcoes.appendChild(btnExcluir);

      tr.appendChild(tdImg);
      tr.appendChild(tdDesc);
      tr.appendChild(tdValor);
      tr.appendChild(tdQtd);
      tr.appendChild(tdEst);
      tr.appendChild(tdAcoes);

      return tr;
    }

    function iniciarEdicao(id, produto) {
      inputId.value = id;
      inputDescricao.value = produto.descricao || "";
      inputValor.value = produto.valor ?? "";
      inputQuantidade.value = produto.quantidade ?? "";
      inputEstoque.value = produto.estoque ?? "";
      imagemURLTemp = produto.imagemURL || "";
      btnSalvar.textContent = "Atualizar";
    }

    // Upload da imagem
    inputImagemFile.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const storageRef = storage.ref("produtos/" + Date.now() + "_" + file.name);
      const uploadTask = storageRef.put(file);

      statusUpload.textContent = "Enviando imagem...";

      uploadTask.on("state_changed",
        snapshot => {
          const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
          statusUpload.textContent = "Enviando: " + progress.toFixed(0) + "%";
        },
        error => {
          console.error("Erro upload:", error);
          alert("Erro ao enviar imagem: " + error.message);
          statusUpload.textContent = "";
        },
        async () => {
          imagemURLTemp = await uploadTask.snapshot.ref.getDownloadURL();
          statusUpload.textContent = "Upload concluído ✔️";
        }
      );
    });

    // Listagem em tempo real
    produtosRef.on("value", snapshot => {
      tbody.innerHTML = "";
      if (!snapshot.exists()) {
        tbody.innerHTML = "<tr><td colspan='6'>Nenhum produto cadastrado</td></tr>";
        return;
      }
      snapshot.forEach(child => {
        tbody.appendChild(montarLinha(child.key, child.val()));
      });
    });

    btnSalvar.onclick = salvarProduto;
    btnLimpar.onclick = limparCampos;
  </script>
</body>
</html>
